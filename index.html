<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JS 테트리스 최종판</title>
    <style>
        body { background: #1a1a1e; color: #fff; font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        
        /* 시작 화면 */
        #start-screen { text-align: center; background: #2a2a2e; padding: 50px; border-radius: 20px; z-index: 100; display: block; }
        
        /* 게임 화면 (기본적으로 숨김 상태) */
        #game-layout { display: none; position: relative; border: 5px solid #333; }
        
        input { padding: 15px; font-size: 18px; width: 250px; margin-bottom: 20px; border-radius: 8px; border: none; text-align: center; }
        button { padding: 15px 40px; font-size: 20px; background: #0DFF72; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        canvas { background: #000; display: block; }
        .side-panel { position: absolute; top: 0; right: -200px; width: 180px; padding: 20px; background: #2a2a2e; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>TETRIS</h1>
        <input type="text" id="nameInput" placeholder="닉네임을 입력하세요">
        <br>
        <button id="startBtn">게임 시작하기</button>
    </div>

    <div id="game-layout">
        <canvas id="tetris" width="240" height="400"></canvas>
        <div class="side-panel">
            <div id="pName" style="color:#0DC2FF; font-weight:bold; font-size:20px;"></div>
            <div style="font-size:24px;">Score: <span id="score">0</span></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('tetris');
        const context = canvas.getContext('2d');
        const nameInput = document.getElementById('nameInput');
        const startBtn = document.getElementById('startBtn');
        const startScreen = document.getElementById('start-screen');
        const gameLayout = document.getElementById('game-layout');
        const pNameDisplay = document.getElementById('pName');

        context.scale(20, 20);

        const colors = [null, '#FF0D72', '#0DC2FF', '#0DFF72', '#F538FF', '#FF8E0D', '#FFE138', '#3877FF'];
        const arena = Array.from({length: 20}, () => new Array(12).fill(0));
        const player = { pos: {x: 0, y: 0}, matrix: null, score: 0 };

        // 시작 버튼 이벤트 리스너 (이 부분이 화면을 전환함)
        startBtn.onclick = function() {
            const nick = nameInput.value.trim();
            if (nick === "") {
                alert("이름을 꼭 입력해 주세요!");
                return;
            }
            
            console.log("게임 시작 요청됨:", nick); // 확인용 로그
            pNameDisplay.innerText = nick;
            
            // 핵심: CSS의 display 속성을 직접 변경
            startScreen.style.setProperty('display', 'none', 'important');
            gameLayout.style.setProperty('display', 'block', 'important');
            
            playerReset();
            update();
        };

        function createPiece(type) {
            if (type === 'I') return [[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]];
            if (type === 'L') return [[0,2,0],[0,2,0],[0,2,2]];
            if (type === 'J') return [[0,3,0],[0,3,0],[3,3,0]];
            if (type === 'O') return [[4,4],[4,4]];
            if (type === 'Z') return [[5,5,0],[0,5,5]];
            if (type === 'S') return [[0,6,6],[6,6,0]];
            if (type === 'T') return [[0,7,0],[7,7,7]];
        }

        function draw() {
            context.fillStyle = '#000';
            context.fillRect(0, 0, canvas.width, canvas.height);
            drawMatrix(arena, {x: 0, y: 0});
            drawMatrix(player.matrix, player.pos);
        }

        function drawMatrix(matrix, offset) {
            matrix.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value !== 0) {
                        context.fillStyle = colors[value];
                        context.fillRect(x + offset.x, y + offset.y, 1, 1);
                    }
                });
            });
        }

        function collide(arena, player) {
            const [m, o] = [player.matrix, player.pos];
            for (let y = 0; y < m.length; ++y) {
                for (let x = 0; x < m[y].length; ++x) {
                    if (m[y][x] !== 0 && (arena[y + o.y] && arena[y + o.y][x + o.x]) !== 0) return true;
                }
            }
            return false;
        }

        function merge(arena, player) {
            player.matrix.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value !== 0) arena[y + player.pos.y][x + player.pos.x] = value;
                });
            });
        }

        function playerDrop() {
            player.pos.y++;
            if (collide(arena, player)) {
                player.pos.y--;
                merge(arena, player);
                playerReset();
                arenaSweep();
            }
            dropCounter = 0;
        }

        function playerReset() {
            const pieces = 'ILJOTSZ';
            player.matrix = createPiece(pieces[pieces.length * Math.random() | 0]);
            player.pos.y = 0;
            player.pos.x = (arena[0].length / 2 | 0) - (player.matrix[0].length / 2 | 0);
            if (collide(arena, player)) {
                alert("게임 오버!");
                arena.forEach(row => row.fill(0));
                player.score = 0;
                document.getElementById('score').innerText = 0;
            }
        }

        function arenaSweep() {
            let rowCount = 1;
            outer: for (let y = arena.length - 1; y > 0; --y) {
                for (let x = 0; x < arena[y].length; ++x) { if (arena[y][x] === 0) continue outer; }
                const row = arena.splice(y, 1)[0].fill(0);
                arena.unshift(row);
                ++y;
                player.score += rowCount * 10;
                rowCount *= 2;
            }
            document.getElementById('score').innerText = player.score;
        }

        let dropCounter = 0;
        let lastTime = 0;
        function update(time = 0) {
            const deltaTime = time - lastTime;
            lastTime = time;
            dropCounter += deltaTime;
            if (dropCounter > 1000) playerDrop();
            draw();
            requestAnimationFrame(update);
        }

        document.addEventListener('keydown', event => {
            if (event.keyCode === 37) { player.pos.x--; if(collide(arena, player)) player.pos.x++; }
            else if (event.keyCode === 39) { player.pos.x++; if(collide(arena, player)) player.pos.x--; }
            else if (event.keyCode === 40) { playerDrop(); }
            else if (event.keyCode === 32) { while(!collide(arena, player)) { player.pos.y++; } player.pos.y--; playerDrop(); }
        });
    </script>
</body>
</html>
